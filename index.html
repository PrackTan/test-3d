<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Love Particles Mobile</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: white;
            -webkit-user-select: none; /* Ch·∫∑n ch·ªçn vƒÉn b·∫£n tr√™n ƒët */
            user-select: none;
        }

        /* Video input ·∫©n */
        #input_video {
            position: absolute;
            top: 0; left: 0;
            width: 1px; height: 1px;
            opacity: 0;
            z-index: -1;
        }

        /* UI Container - Responsive */
        #ui-container {
            position: absolute;
            z-index: 10;
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px); /* Cho Safari iOS */
            padding: 20px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        /* Desktop Style */
        @media (min-width: 769px) {
            #ui-container {
                top: 20px;
                left: 20px;
                width: 250px;
            }
        }

        /* Mobile Style (M√†n h√¨nh d·ªçc) */
        @media (max-width: 768px) {
            #ui-container {
                bottom: 20px; /* N·∫±m d∆∞·ªõi ƒë√°y */
                left: 15px;
                right: 15px;
                width: auto; /* Full chi·ªÅu ngang */
                padding: 15px;
            }
            
            h1 { font-size: 16px !important; }
            .instruction { font-size: 10px !important; }
        }

        h1 {
            font-size: 18px;
            margin: 0 0 10px 0;
            font-weight: 700;
            background: linear-gradient(to right, #ff4d6d, #ff8fa3);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .control-group { margin-bottom: 10px; }
        
        label {
            display: block;
            font-size: 11px;
            margin-bottom: 5px;
            color: #ddd;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Custom Color Picker cho ƒë·∫πp h∆°n */
        .color-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        input[type="color"] {
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            background: none;
            padding: 0;
        }
        
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; border: 2px solid #fff; }

        #status {
            font-size: 13px;
            color: #00ff88;
            margin-top: 5px;
            font-weight: 500;
        }

        .instruction {
            font-size: 11px;
            color: #aaa;
            margin-top: 10px;
            line-height: 1.4;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 8px;
        }
        
        /* Preview Canvas nh·ªè */
        #preview-canvas {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 100px; /* Nh·ªè h∆°n tr√™n mobile */
            height: 75px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            z-index: 5;
            transform: scaleX(-1);
            opacity: 0.8;
            background: #000;
        }
    </style>
</head>
<body>

    <video id="input_video" playsinline webkit-playsinline muted></video>
    
    <canvas id="preview-canvas"></canvas>

    <div id="ui-container">
        <h1>Love AI Mobile</h1>
        <div class="control-group">
            <label>M√†u H·∫°t</label>
            <div class="color-wrapper">
                <input type="color" id="colorPicker" value="#ff4d6d">
                <span style="font-size: 12px; color: #fff;">Ch·∫°m ƒë·ªÉ ƒë·ªïi m√†u</span>
            </div>
        </div>
        <div id="status">ƒêang m·ªü camera...</div>
        <div class="instruction">
            üëã <b>D·ª±ng ƒëi·ªán tho·∫°i l√™n & l√πi ra xa.</b><br>
            ƒê∆∞a 1 tay v√†o khung h√¨nh:
            <br>‚Ä¢ <b>N·∫Øm tay:</b> I ‚ô• Qu·ª≥nh l√πn
            <br>‚Ä¢ <b>M·ªü tay:</b> N·ªï tung
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- C·∫§U H√åNH ---
        const CONFIG = {
            particleCount: 2500, // Gi·∫£m nh·∫π cho mobile ƒë·ª° lag
            particleSize: 0.2,   // To h∆°n x√≠u cho d·ªÖ nh√¨n tr√™n ƒët
            spreadRadius: 12,
            textScale: 0.12,
            morphSpeed: 0.08
        };

        let scene, camera, renderer, particles;
        let targetPositions, randomPositions;
        let interactionFactor = 0; 
        let material;

        const statusEl = document.getElementById('status');
        const colorPicker = document.getElementById('colorPicker');
        const previewCanvas = document.getElementById('preview-canvas');
        const previewCtx = previewCanvas.getContext('2d');

        function initThree() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x050505, 0.025);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            // T·ª∞ ƒê·ªòNG ƒêI·ªÄU CH·ªàNH CAMERA D·ª∞A TR√äN M√ÄN H√åNH
            adjustCameraPosition();

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Gi·ªõi h·∫°n pixel ratio ƒë·ªÉ ƒë·ª° n√≥ng m√°y
            document.body.appendChild(renderer.domElement);

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                adjustCameraPosition();
            });

            createParticles();
            animate();
        }

        function adjustCameraPosition() {
            const aspect = window.innerWidth / window.innerHeight;
            if (aspect < 1) {
                // M√†n h√¨nh d·ªçc (ƒêi·ªán tho·∫°i): L√πi xa h∆°n
                camera.position.z = 22; 
            } else {
                // M√†n h√¨nh ngang (PC): G·∫ßn h∆°n
                camera.position.z = 12;
            }
        }

        function createParticles() {
            const textPoints = getTextPoints("I ‚ô• Qu·ª≥nh l√πn");
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(CONFIG.particleCount * 3);
            
            targetPositions = new Float32Array(CONFIG.particleCount * 3);
            randomPositions = new Float32Array(CONFIG.particleCount * 3);

            for (let i = 0; i < CONFIG.particleCount; i++) {
                // Target: Ch·ªØ
                const pIndex = i % textPoints.length;
                targetPositions[i * 3] = textPoints[pIndex].x;
                targetPositions[i * 3 + 1] = textPoints[pIndex].y;
                targetPositions[i * 3 + 2] = (Math.random() - 0.5) * 1.5;

                // Random: H√¨nh c·∫ßu
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos((Math.random() * 2) - 1);
                const r = 6 + Math.random() * CONFIG.spreadRadius;

                randomPositions[i * 3] = r * Math.sin(phi) * Math.cos(theta);
                randomPositions[i * 3 + 1] = r * Math.sin(phi) * Math.sin(theta);
                randomPositions[i * 3 + 2] = r * Math.cos(phi);

                positions[i * 3] = randomPositions[i * 3];
                positions[i * 3 + 1] = randomPositions[i * 3 + 1];
                positions[i * 3 + 2] = randomPositions[i * 3 + 2];
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

            const sprite = new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/disc.png');

            material = new THREE.PointsMaterial({
                color: new THREE.Color(colorPicker.value),
                size: CONFIG.particleSize,
                map: sprite,
                transparent: true,
                opacity: 0.9,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        function getTextPoints(text) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const width = 250; // Canvas r·ªông h∆°n ch√∫t
            const height = 100;
            canvas.width = width;
            canvas.height = height;

            ctx.fillStyle = '#FFFFFF';
            // Font ƒë·∫≠m h∆°n ƒë·ªÉ r√µ tr√™n mobile
            ctx.font = '900 50px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto'; 
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, width / 2, height / 2);

            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            const points = [];

            for (let y = 0; y < height; y += 2) {
                for (let x = 0; x < width; x += 2) {
                    if (data[(y * width + x) * 4 + 3] > 128) {
                        points.push({
                            x: (x - width / 2) * CONFIG.textScale,
                            y: -(y - height / 2) * CONFIG.textScale,
                        });
                    }
                }
            }
            return points;
        }

        // --- MEDIAPIPE SETUP ---
        const videoElement = document.getElementById('input_video');

        function onResults(results) {
            // Ch·ªâ v·∫Ω l√™n preview canvas, kh√¥ng log ra console ƒë·ªÉ ƒë·ª° lag
            previewCtx.save();
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
            previewCtx.drawImage(results.image, 0, 0, previewCanvas.width, previewCanvas.height);
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length === 1) {
                const hand = results.multiHandLandmarks[0];
                
                // Ph√°t hi·ªán c·ª≠ ch·ªâ: N·∫Øm tay (fist) vs M·ªü tay (open)
                // S·ª≠ d·ª•ng kho·∫£ng c√°ch t·ª´ c·ªï tay (0) ƒë·∫øn ƒë·∫ßu ng√≥n tay (4, 8, 12, 16, 20)
                const wrist = hand[0];
                const thumbTip = hand[4];
                const indexTip = hand[8];
                const middleTip = hand[12];
                const ringTip = hand[16];
                const pinkyTip = hand[20];
                
                // T√≠nh kho·∫£ng c√°ch t·ª´ c·ªï tay ƒë·∫øn c√°c ƒë·∫ßu ng√≥n tay
                const distThumb = Math.sqrt(Math.pow(wrist.x - thumbTip.x, 2) + Math.pow(wrist.y - thumbTip.y, 2));
                const distIndex = Math.sqrt(Math.pow(wrist.x - indexTip.x, 2) + Math.pow(wrist.y - indexTip.y, 2));
                const distMiddle = Math.sqrt(Math.pow(wrist.x - middleTip.x, 2) + Math.pow(wrist.y - middleTip.y, 2));
                const distRing = Math.sqrt(Math.pow(wrist.x - ringTip.x, 2) + Math.pow(wrist.y - ringTip.y, 2));
                const distPinky = Math.sqrt(Math.pow(wrist.x - pinkyTip.x, 2) + Math.pow(wrist.y - pinkyTip.y, 2));
                
                // Trung b√¨nh kho·∫£ng c√°ch c√°c ng√≥n tay
                const avgDist = (distThumb + distIndex + distMiddle + distRing + distPinky) / 5;
                
                // N·∫Øm tay: kho·∫£ng c√°ch nh·ªè (< 0.15) -> interactionFactor = 0 (hi·ªán ch·ªØ)
                // M·ªü tay: kho·∫£ng c√°ch l·ªõn (> 0.25) -> interactionFactor = 1 (n·ªï tung)
                let val = (avgDist - 0.15) / (0.25 - 0.15);
                val = Math.max(0, Math.min(1, val));
                interactionFactor += (val - interactionFactor) * 0.1;

                const gesture = avgDist < 0.18 ? "N·∫Øm tay" : "M·ªü tay";
                statusEl.innerHTML = gesture + " (" + Math.round(avgDist * 100) + "%)";
                statusEl.style.color = "#00ff88";
                
                drawConnectors(previewCtx, results.multiHandLandmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
            } else {
                // T·ª± ƒë·ªông tr√¥i v·ªÅ tr·∫°ng th√°i ch·ªØ n·∫øu kh√¥ng th·∫•y tay
                interactionFactor += (0 - interactionFactor) * 0.05;
                statusEl.innerText = "ƒêang t√¨m tay...";
                statusEl.style.color = "#ff4d6d";
            }
            previewCtx.restore();
        }

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        
        // C·∫•u h√¨nh nh·∫π h∆°n cho mobile (Lite model)
        hands.setOptions({
            maxNumHands: 1, // Ch·ªâ c·∫ßn 1 tay
            modelComplexity: 0, // 0: Lite (Nhanh nh·∫•t), 1: Full
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        hands.onResults(onResults);

        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 480, // Gi·∫£m ƒë·ªô ph√¢n gi·∫£i x·ª≠ l√Ω AI xu·ªëng 480p ƒë·ªÉ nhanh h∆°n
            height: 360,
            facingMode: "user" // Camera tr∆∞·ªõc
        });
        cameraUtils.start();

        function animate() {
            requestAnimationFrame(animate);

            const positions = particles.geometry.attributes.position.array;
            
            for (let i = 0; i < CONFIG.particleCount; i++) {
                const ix = i * 3;
                const iy = i * 3 + 1;
                const iz = i * 3 + 2;

                const targetX = targetPositions[ix] + (randomPositions[ix] - targetPositions[ix]) * interactionFactor;
                const targetY = targetPositions[iy] + (randomPositions[iy] - targetPositions[iy]) * interactionFactor;
                const targetZ = targetPositions[iz] + (randomPositions[iz] - targetPositions[iz]) * interactionFactor;

                positions[ix] += (targetX - positions[ix]) * CONFIG.morphSpeed;
                positions[iy] += (targetY - positions[iy]) * CONFIG.morphSpeed;
                positions[iz] += (targetZ - positions[iz]) * CONFIG.morphSpeed;

                // Rung nh·∫π
                if (interactionFactor < 0.1) {
                    positions[ix] += (Math.random() - 0.5) * 0.03;
                    positions[iy] += (Math.random() - 0.5) * 0.03;
                    positions[iz] += (Math.random() - 0.5) * 0.03;
                }
            }

            particles.geometry.attributes.position.needsUpdate = true;
            particles.rotation.y += 0.002; // Xoay ch·∫≠m t·ª± ƒë·ªông ƒë·ªÉ ƒë·∫πp tr√™n mobile
            
            renderer.render(scene, camera);
        }

        colorPicker.addEventListener('input', (e) => {
            if (material) material.color.set(e.target.value);
        });

        initThree();
    </script>
</body>
</html>